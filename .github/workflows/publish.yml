name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Push for Hostinger
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          tools: composer:v2

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Composer dependencies (production)
        working-directory: ./capstone_system
        run: |
          composer install --prefer-dist --no-progress --no-dev --optimize-autoloader --no-interaction

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f LLM/requirements.txt ]; then pip install --only-binary=:all: -r LLM/requirements.txt || pip install -r LLM/requirements.txt; fi
          if [ -f RandomForest/requirements.txt ]; then pip install --only-binary=:all: -r RandomForest/requirements.txt || pip install -r RandomForest/requirements.txt; fi

      - name: Install NPM dependencies and build assets
        working-directory: ./capstone_system
        run: |
          npm ci --only=production
          npm run build

      - name: Create Hostinger deployment structure
        run: |
          mkdir -p build/public_html
          cd capstone_system
          cp -r app bootstrap config database resources routes storage vendor ../build/
          cp artisan composer.json composer.lock ../build/
          cp -r public/* ../build/public_html/
          cp public/.htaccess ../build/public_html/ 2>/dev/null || true
          cp .env.example ../build/.env
          cd ..
          sed -i "s|__DIR__.'/../vendor/autoload.php'|__DIR__.'/../vendor/autoload.php'|g" build/public_html/index.php
          sed -i "s|__DIR__.'/../bootstrap/app.php'|__DIR__.'/../bootstrap/app.php'|g" build/public_html/index.php
          chmod -R 775 build/storage build/bootstrap/cache
          if [ -d "LLM" ]; then cp -r LLM build/; fi
          if [ -d "RandomForest" ]; then cp -r RandomForest build/; fi
          echo '<IfModule mod_rewrite.c>' > build/.htaccess
          echo '    RewriteEngine On' >> build/.htaccess
          echo '    RewriteRule ^(.*)$ public_html/$1 [L]' >> build/.htaccess
          echo '</IfModule>' >> build/.htaccess

      - name: Push to deploy branch
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: deploy-hostinger
          FOLDER: build
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Deploy: ({sha}) {msg}"