name: Generate a build and push to another branch

on:
  push:
    branches:
      - main # The branch name your are commit the new changes

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Push
    steps:
      - name: git-checkout
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x' # Adjust to your Python version

      - name: Install Composer dependencies
        run: |
          cd capstone_system
          composer install --prefer-dist --no-progress --no-dev --optimize-autoloader

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install NPM dependencies
        run: |
          cd capstone_system
          npm install

      - name: Build assets
        run: |
          cd capstone_system
          npm run build

      - name: Create build directory
        run: |
          mkdir -p build
          cd capstone_system
          cp -r public ../build/
          cp -r vendor ../build/
          cp -r app ../build/
          cp -r config ../build/
          cp -r database ../build/
          cp -r resources ../build/
          cp -r routes ../build/
          cp -r storage ../build/
          cp -r bootstrap ../build/
          cp artisan ../build/
          cp composer.json ../build/
          cp composer.lock ../build/
          cp .env.example ../build/.env
          cd ..
          # Add Python/ML components
          if [ -d "LLM" ]; then cp -r LLM build/; fi
          if [ -d "RandomForest" ]; then cp -r RandomForest build/; fi

      - name: Push
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: build
          FOLDER: build
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Build: ({sha}) {msg}"